version: "3.9"

# ch4p gateway — docker-compose for local development and simple deployments
#
# Quick start:
#   cp .env.example .env        # fill in your API keys
#   docker compose up -d
#
# The gateway will be available at http://localhost:3141

services:
  gateway:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    image: ch4p:latest
    restart: unless-stopped
    ports:
      - "${CH4P_PORT:-3141}:3141"
    volumes:
      # Persist the config file and SQLite memory database
      - ch4p-data:/data
      # Mount your config file (read-only)
      - ${CH4P_CONFIG:-~/.ch4p/config.json}:/data/config.json:ro
    environment:
      # Tell the CLI to look for config in /data
      CH4P_CONFIG_DIR: /data
      # Forward API keys from host .env — set only the ones you use
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3141/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  ch4p-data:
